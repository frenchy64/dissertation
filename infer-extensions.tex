\Dchapter{Extensions}

%\Dsection{Polymorphic types}
%
%\begin{figure}
%  \ifdefined\PAPER
%  \footnotesize
%  \fi
%\begin{mathpar}
%  \begin{altgrammar}
%   \e{} &::=& ...
%       \alt \trackpolyE{\e{}}{\inferpath{}}{\e{}}
%       \alt \genE{}
%       &\mbox{Expressions}
%  \end{altgrammar}
%
%  \infer [B-Gen]
%  { \num{} \text{ is fresh}
%  }
%  { \opsemtrack{\openv{}}{\genE{}}{\num{}}{\emptyres{}}}
%
%  \infer [B-TrackPoly]
%  { \bigstepgen{\openv{}}{\num0}{\e{}}{\v{}}{\res{1}}{\num1} 
%    \\\\
%    \bigstepgen{\openv{}}{\num1}{\ep{}}{\num{}}{\res{2}}{\num2}
%    \\\\
%    \trackpolymeta{}(\v{}, \inferpath{}, {\num{}}) = \vp{}\ ; \res{3} }
%  { \bigstepgen{\openv{}}{\num0}{\trackpolyE{\e{}}{\inferpath{}}{\ep{}}}{\vp{}}{\bigunionres{\ova{\res{}}}}{\num2} }
%
%  \begin{array}{lllll}
%    \trackpolymeta{}(\v{}, \inferpath{}, \num{}) = \v{}\ ;\ \res{}\\\\
%
%    \trackpolymeta{}(\num{}, \inferpath{}, \num{}')
%    &=&
%    n\ ; \{\inferpath{} : \IntT{}\}
%    \\
%    \trackpolymeta{}([\lambda \xvar{}. \e{}, \openv{}], \inferpath{}, \num{})
%    &=&
%    [
%    \lambda \yvar{}.
%    \inferletliteral (\xvar{n} \genE{})
%    \\&&
%    FIXME
%      %\trackpolyE{((\lambda \xvar{}. \e{}) \trackpolyE{\yvar{}}{\appendone{\inferpath{}}{\dompe{}}}{\xvar{n}})}
%      %       {\appendone{\inferpath{}}{\rngpe{}}}{\xvar{n}}
%      %   , \openv{}]
%      %   \ ; \{\inferpath{} : [\UnknownT{} \rightarrow \UnknownT{}] \}
%         \\
%    &&
%    \text{where}\ \yvar{} \text{ is fresh}
%    \\
%    \trackpolymeta{}(\{\ova{\val1\ \val2}\}, \inferpath{}, \num{})
%    &=&
%    \{\ova{\val1\ \val2{}'}\}
%    \ ;\ \ova{\sqcup\ \res{}}
%      \sqcup
%    \{\inferpath{} : \{\ova{\val1\ \UnknownT{}}\} \}
%    \\
%    &&
%    \text{where}\ \ova{\trackpolymeta{}(\val2, \appendone{\inferpath{}}{\inferkeype{\ova{\val1}}{\val1}}) = \val2{}'\ ;\ \res{}}
%  \end{array}
%\end{mathpar}
%  \caption{Polymorphic type tracking extensions }
%\end{figure}

\Dsection{Space efficient tracking}

To reduce the overhead of runtime tracking, we can borrow
the concept of ``space efficient'' contract checking from
the gradual typing literature~\cite{Herman:2010}.
%
Instead of tracking just one path at once, a space efficient
implementation of track threads through a set of paths.
When a tracked value flows into another tracked position,
we extract the unwrapped value, and then our new tracked value
tracks the paths that is the set of the old paths with the new path.

To model this, we introduce a new kind of value \ProxyV{\v{}}{\closure{\e{}}{\openv{}}}{\ova{\inferpath{}}}
that tracks old value \v{} as new value \closure{\e{}}{\openv{}} with the paths \ova{\inferpath{}}.
Proxy expressions are introduced when tracking functions, where instead of just returning
a new wrapped function, we return a proxy.
We can think of function proxies as a normal function with some extra metadata, so we
can reuse the existing semantics for function application---in fact we
can support space-efficient function tracking just by extending \trackEOp{}.

We present the extension in \figref{fig:infer:proxyext}.
The first two \trackEOp{} rules simply make inference
results for each of the paths.
The next rule says that a bare closure
reduces to a proxy that tracks the domain and range
of the closure with respect to the list of paths.
Attached to the proxy is everything needed to extend
it with more paths, which is the role of the
final rule. It extracts the original closure from the
proxy and creates a new proxy with updated paths
via the previous rule.

\begin{figure}
  \ifdefined\PAPER
  \footnotesize
  \fi
\begin{mathpar}
  \begin{altgrammar}
    \v{} &::=& ... \alt \ProxyVdiff{\closure{\uabs{\x{}}{\e{}}}{\openv{}}}{\closure{\uabs{\x{}}{\e{}}}{\openv{}}}{\ova{\inferpath{}}}
       &\mbox{Values}
  \end{altgrammar}

  \arraycolsep=1.4pt
  \begin{array}{lllll}
    \trackmetaalign{\num{}}{\ovadiff{\inferpath{}}}{\num{}}{\proxyextdiff{\bigunionres{\ovadiff{\proxyextsame{\singletonres{\inferpath{}}{\IntT{}}}}}}}\\
    \trackmetaalign{\kw{}}{\ovadiff{\inferpath{}}}{\kw{}}
                   {\proxyextdiff{\bigunionres{\ovadiff{\proxyextsame{\singletonres{\inferpath{}}{\Keyword{}}}}}}}\\
    \trackmetaalign{\closure{\uabs{\x{}}{\e{}}}{\openv{}}}
                   {\ovadiff{\inferpath{}}}
                   {\ProxyVdiff{\closure{\uabs{\x{}}{\e{}}}{\openv{}}}
                               {\closure{\ep{}}{\openv{}}}
                               {\ova{\inferpath{}}}}
                   {\emptyres{}}
         \\
    &&
    \begin{array}{@{}llll}
      \text{where } \yvar{} \text{ is fresh},\\
                    \begin{array}{lllll}
                        \ep{} =
                          \uabs{\y{}}{\trackE{&\appexp{(\uabs{\x{}}{\e{}})}{\trackE{\yvar{}}{\ovadiff{\appendone{\inferpath{}}{\dompe{}}}}}}
                                             {\\&\ovadiff{\appendone{\inferpath{}}{\rngpe{}}}}}
                     \end{array}
    \end{array}
                
    \\
    \trackmetaalignsplice{\ProxyV{\closure{\uabs{\x{}}{\e{}}}{\openv{}}}{\closure{\ep{}}{\openvp{}}}{\ova{\inferpathp{}}}}{\ova{\inferpath{}}}
                         {\trackmetalhs{\closure{\uabs{\x{}}{\e{}}}{\openv{}}}{\ova{\inferpath{}} \cup \ova{\inferpathp{}}}}
  \end{array}
\end{mathpar}
  \caption{Space efficient tracking extensions (\textcolor{red}{changes})}
  \label{fig:infer:proxyext}
\end{figure}

\Dsection{Lazy tracking}



\begin{figure}
  \ifdefined\PAPER
  \footnotesize
  \fi
\begin{mathpar}
  \begin{altgrammar}
    \v{} &::=& ... \alt \MProxyVdiff{\curlymap{\ova{\kw{}\ \v{}}}}{\curlymap{\ova{\kw{}\ \curlymap{\ova{\HMapreq{}\ \ova{\inferpath{}}}}}}}
       &\mbox{Values}
  \end{altgrammar}

  \arraycolsep=1.4pt
  \begin{array}{lllll}
    \trackmetaalign{\curlymap{\ova{\kw{i}\ \kwp{i}}^{1 \leq i \leq n}\ \ova{\kw{j}\ \v{j}}^{n < j \leq p}}}
                   {\ovadiff{\inferpath{}}}
                   {\MProxyVdiff{\curlymap{\ova{\kw{i}\ \kwp{i}}^{1 \leq i \leq n}\ \ova{\kw{j}\ \proxyextdiff{\v{j}}}^{n < j \leq p}}}
                                {\curlymap{\ova{\kw{}\ \{\HMapreq{}\ \ova{\inferpath{}}\}}}}}
                   {\proxyextdiff{\emptyres{}}}
                   \\
                   &&
    \begin{array}{@{}llll}
      \text{where } \HMapreq{} = {\curlymap{\ova{\kw{i}\ \kwp{i}}^{1 \leq i \leq n}\ \ova{\kw{j}\ \UnknownT{}}^{n < j \leq p}}}
    \end{array}
    \\
    \trackmetaalign{\MProxyVdiff{\curlymap{\ova{\kw{}\ \v{}}}}
                                {\curlymap{\ova{\kwp{}\ \{\HMapreq{}\ \ova{\inferpathp{}}\}}}}}
                   {\ovadiff{\inferpath{}}}
                   {\MProxyVdiff{\curlymap{\ova{\kw{}\ \v{}}}}
                                {\curlymap{\ova{\kwp{}\ \{\HMapreq{}\ (\ova{\inferpath{} \cup}\ \cup\ {\ova{\inferpathp{} \cup}})\}}}}}
                   {\emptyres{}}
  \end{array}

  \arraycolsep=1.4pt
  \begin{array}{lllr}
    \inferconstantopsemalignnospace
      {\assocliteral{}}
      {\MProxyVdiff{\curlymap{\ova{\kw{}\ \v{}}}}{\curlymap{\kwp{}\ \textsf{t}', \ova{\kwpp{}\ \textsf{t}}}}
       , \kwp{}
       , \vp{}}
      {\MProxyVdiff{\updatemap{\curlymap{\ova{\kw{}\ \v{}}}}{\kwp{}}{\vp{}}}
               {\curlymap{\ova{\kwpp{}\ \textsf{t}}}}}
      {\emptyres{}}\\
    \inferconstantopsemalignnospace
      {\assocliteral{}}
      {\MProxyVdiff{\curlymap{\ova{\kw{}\ \v{}}}}
                   {\curlymap{\ova{\kwpp{}\ \textsf{t}}}}
       , \kwp{}
       , \vp{}}
      {\MProxyVdiff{\updatemap{\curlymap{\ova{\kw{}\ \v{}}}}{\kwp{}}{\vp{}}}
                   {\curlymap{\ova{\kwpp{}\ \textsf{t}}}}}
      {\emptyres{}}\\
    \inferconstantopsemalignsplice
      {\getliteral{}}
      {\MProxyVdiff{\curlymap{\kw{}\ \v{}, \ova{\kwp{}\ \vp{}}}}
                   {\curlymap{\kw{}\ \textsf{t}, \ova{\kwpp{}\ \textsf{t}'}}}
       , \kw{}}
      {\proxyextdiff{\trackmetalhs{\proxyextsame{\v{}}}{\ova{\inferpath{}}}}}\\
      \begin{array}{lllll}
        \text{ where } \ova{\inferpath{}} = \big[\appendone{\inferpath{}}{\inferkeype{\HMapreq{}}{\kw{}}}
                                                \ |\
                                                (\HMapreq{}, \ova{\inferpath{}}) \in \textsf{t}, 
                                                \inferpath{} \in \ova{\inferpath{}}
                                           \big]
      \end{array}
      \\
    \inferconstantopsemalign
      {\dissocliteral{}}
      {\MProxyVdiff{\curlymap{\kw{}\ \v{}, \ova{\kwp{}\ \vp{}}}}
                   {\curlymap{\kw{}\ \textsf{t}, \ova{\kwpp{}\ \textsf{t}'}}}
       , \kw{}}
      {\MProxyVdiff{\curlymap{\ova{\kwp{}\ \vp{}}}}
                   {\curlymap{\ova{\kwpp{}\ \textsf{t}'}}}}
      {\emptyres{}}
      \\
    \inferconstantopsemalign
      {\dissocliteral{}}
      {\MProxyVdiff{\curlymap{\kw{}\ \v{}, \ova{\kwp{}\ \vp{}}}}
                   {\curlymap{\ova{\kwpp{}\ \textsf{t}'}}}
       , \kw{}}
      {\MProxyVdiff{\curlymap{\ova{\kwp{}\ \vp{}}}}
                   {\curlymap{\ova{\kwpp{}\ \textsf{t}'}}}}
      {\emptyres{}}
  \end{array}
\end{mathpar}
  \caption{Lazy tracking extensions (\textcolor{red}{changes})}
\end{figure}
